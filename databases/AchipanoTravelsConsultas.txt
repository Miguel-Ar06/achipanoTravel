
CREATE DATABASE achipano_travel;
USE achipano_travel;


CREATE TABLE turistas(
    id_turista VARCHAR(100) PRIMARY KEY ,
    nombre VARCHAR(100) NOT NULL,
    apellido VARCHAR(100) NOT NULL,
    telefono VARCHAR(100) NOT NULL UNIQUE,
    correo VARCHAR(100) NOT NULL UNIQUE,
    ubicacion VARCHAR(100) NOT NULL
);

CREATE TABLE hoteles(
    id_hotel INT PRIMARY KEY AUTO_INCREMENT,
    nombre VARCHAR(100) NOT NULL,
    rif VARCHAR(100) NOT NULL UNIQUE,
    ubicacion VARCHAR(100) NOT NULL,

    CONSTRAINT uq_hotel_nombre_ubicacion
    UNIQUE (nombre,ubicacion)
);

CREATE TABLE tipo_habitaciones(
    id_tipo_habitacion INT PRIMARY KEY AUTO_INCREMENT,
    descripcion VARCHAR(100) NOT NULL,
    precio_base DECIMAL(10,2) NOT NULL CHECK ( precio_base > 0 ),
    id_hotel INT NOT NULL,
    cantidad_personas INT NOT NULL CHECK ( cantidad_personas > 0 ),

    CONSTRAINT fk_habitacion_hotel
    FOREIGN KEY (id_hotel) REFERENCES hoteles(id_hotel),

    CONSTRAINT uq_tipo_habitacion_hotel
    UNIQUE (descripcion,id_hotel)
);

CREATE TABLE tarifas(
    id_tarifa INT PRIMARY KEY AUTO_INCREMENT,
    multiplo_precio DECIMAL(4,2) NOT NULL , -- Este se multiplica por el precio base , ej: la fecha en sunsol del dia x al dia y cuesta el doble para habitaciones individuales
    inicio_temporada DATE NOT NULL,
    fin_temporada DATE NOT NULL ,

    id_tipo_habitacion INT NOT NULL,

    CONSTRAINT fk_tipo_habitacion_tarifa
    FOREIGN KEY (id_tipo_habitacion) REFERENCES tipo_habitaciones(id_tipo_habitacion)


);

CREATE TABLE habitaciones(
    id_habitacion INT PRIMARY KEY AUTO_INCREMENT,
    numero VARCHAR(100) NOT NULL,

    id_tipo_habitacion INT NOT NULL,


    CONSTRAINT fk_habitacion_y_su_tipo
    FOREIGN KEY (id_tipo_habitacion) REFERENCES  tipo_habitaciones(id_tipo_habitacion)

);

CREATE TABLE reservas (
    id_reserva INT PRIMARY KEY AUTO_INCREMENT,
    fecha_registro DATETIME NOT NULL DEFAULT(NOW()),
    fecha_desde DATE NOT NULL,
    fecha_hasta DATE NOT NULL,
    cantidad_personas INT NOT NULL CHECK ( cantidad_personas > 0 ),
    monto_total DECIMAL(10,2) NOT NULL  CHECK ( monto_total > 0 ),

    id_turista  VARCHAR(100) NOT NULL,
    id_habitacion INT NOT NULL,

    CONSTRAINT fk_turista_reserva
    FOREIGN KEY (id_turista) REFERENCES turistas(id_turista),

    CONSTRAINT fk_habitacion_reserva
    FOREIGN KEY (id_habitacion) REFERENCES habitaciones(id_habitacion)
);

CREATE TABLE disponibilidad_habitaciones (
    id_disponibilidad INT PRIMARY KEY AUTO_INCREMENT,
    id_habitacion INT NOT NULL,
    fecha DATE NOT NULL,
    estado ENUM('disponible', 'reservada') DEFAULT 'disponible',
    id_reserva INT NULL,

    CONSTRAINT fk_disponibilidad_habitacion
    FOREIGN KEY (id_habitacion) REFERENCES habitaciones(id_habitacion),

    CONSTRAINT fk_disponibilidad_reserva
    FOREIGN KEY (id_reserva) REFERENCES reservas(id_reserva),

    CONSTRAINT uq_habitacion_fecha UNIQUE (id_habitacion, fecha)
);

ALTER TABLE reservas ADD CONSTRAINT ck_reserva_fecha_hora CHECK (fecha_hasta > fecha_desde);

ALTER TABLE tarifas ADD CONSTRAINT ck_inicio_fin_temporada CHECK (fin_temporada >= inicio_temporada );

-- El Misero Trigger

DELIMITER //
CREATE TRIGGER after_insert_reserva
AFTER INSERT ON reservas
FOR EACH ROW
BEGIN
    DECLARE fecha_actual DATE;

    SET fecha_actual = NEW.fecha_desde;

    WHILE fecha_actual < NEW.fecha_hasta DO
        INSERT INTO disponibilidad_habitaciones (id_habitacion, fecha, estado, id_reserva)
        VALUES (NEW.id_habitacion, fecha_actual, 'reservada', NEW.id_reserva)
        ON DUPLICATE KEY UPDATE estado = 'reservada', id_reserva = NEW.id_reserva;
        SET fecha_actual = fecha_actual + INTERVAL 1 DAY;
    END WHILE;
END
DELIMITER ;




-- Ahora los inserts

-- Insertar hoteles (ya los tienes con los CALL, pero por si necesitas los INSERT directos)
INSERT INTO hoteles (nombre, rif, ubicacion) VALUES
('Sunsol Punta Blanca', 'J-124765578', 'coche'),
('Sunsol Ecoland', 'J-097365518', 'Pedro Gonzalez'),
('Hesperia', 'J-568792232', 'Pedro Gonzalez'),
('Agua Dorada', 'J-568023454', 'Playa El Agua');

-- Insertar tipos de habitaciones para cada hotel con sus precios base
-- Hotel Sunsol Punta Blanca (id_hotel = 1)
INSERT INTO tipo_habitaciones (descripcion, precio_base, id_hotel, cantidad_personas) VALUES
('Habitación Sencilla', 65.00, 1, 1),
('Habitación Doble', 60.00, 1, 2),
('Habitación Triple', 120.00, 1, 3),
('Habitación Familiar', 111.00, 1, 4);

-- Hotel Sunsol Ecoland (id_hotel = 2)
INSERT INTO tipo_habitaciones (descripcion, precio_base, id_hotel, cantidad_personas) VALUES
('Habitación Sencilla', 75.00, 2, 1),
('Habitación Doble', 70.00, 2, 2),
('Habitación Triple', 130.00, 2, 3),
('Habitación Familiar', 120.00, 2, 4);

-- Hotel Hesperia (id_hotel = 3)
INSERT INTO tipo_habitaciones (descripcion, precio_base, id_hotel, cantidad_personas) VALUES
('Habitación Sencilla', 55.00, 3, 1),
('Habitación Doble', 65.00, 3, 2),
('Habitación Triple', 95.00, 3, 3),
('Habitación Familiar', 98.00, 3, 4);

-- Hotel Agua Dorada (id_hotel = 4)
INSERT INTO tipo_habitaciones (descripcion, precio_base, id_hotel, cantidad_personas) VALUES
('Habitación Sencilla', 60.00, 4, 1),
('Habitación Doble', 75.00, 4, 2),
('Habitación Triple', 105.00, 4, 3),
('Habitación Familiar', 98.00, 4, 4);

-- Insertar tarifas temporales para Sunsol Punta Blanca
INSERT INTO tarifas (multiplo_precio, inicio_temporada, fin_temporada, id_tipo_habitacion) VALUES
-- Temporada 1: 01-01-2025 a 31-03-2025 (precio normal = multiplo 1.0)
(1.0, '2025-01-01', '2025-03-31', 1), (1.0, '2025-01-01', '2025-03-31', 2), (1.0, '2025-01-01', '2025-03-31', 3), (1.0, '2025-01-01', '2025-03-31', 4),
-- Temporada 2: 01-04-2025 a 30-06-2025 (0.92x para sencilla, 0.95x para doble, etc.)
(0.92, '2025-04-01', '2025-06-30', 1), (0.95, '2025-04-01', '2025-06-30', 2), (0.92, '2025-04-01', '2025-06-30', 3), (1.13, '2025-04-01', '2025-06-30', 4),
-- Temporada 3: 01-07-2025 a 30-09-2025
(1.08, '2025-07-01', '2025-09-30', 1), (1.12, '2025-07-01', '2025-09-30', 2), (0.88, '2025-07-01', '2025-09-30', 3), (1.17, '2025-07-01', '2025-09-30', 4),
-- Temporada 4: 01-10-2025 a 15-11-2025
(0.85, '2025-10-01', '2025-11-15', 1), (0.83, '2025-10-01', '2025-11-15', 2), (1.0, '2025-10-01', '2025-11-15', 3), (1.04, '2025-10-01', '2025-11-15', 4),
-- Temporada 5: 16-11-2025 a 28-11-2025
(1.0, '2025-11-16', '2025-11-28', 1), (1.0, '2025-11-16', '2025-11-28', 2), (0.96, '2025-11-16', '2025-11-28', 3), (0.90, '2025-11-16', '2025-11-28', 4),
-- Temporada 6: 29-11-2025 a 31-12-2025
(1.15, '2025-11-29', '2025-12-31', 1), (1.22, '2025-11-29', '2025-12-31', 2), (1.08, '2025-11-29', '2025-12-31', 3), (1.22, '2025-11-29', '2025-12-31', 4);

-- Insertar tarifas temporales para Sunsol Ecoland
INSERT INTO tarifas (multiplo_precio, inicio_temporada, fin_temporada, id_tipo_habitacion) VALUES
(1.0, '2025-01-01', '2025-03-31', 5), (1.0, '2025-01-01', '2025-03-31', 6), (1.0, '2025-01-01', '2025-03-31', 7), (1.0, '2025-01-01', '2025-03-31', 8),
(0.93, '2025-04-01', '2025-06-30', 5), (0.96, '2025-04-01', '2025-06-30', 6), (0.92, '2025-04-01', '2025-06-30', 7), (0.96, '2025-04-01', '2025-06-30', 8),
(1.07, '2025-07-01', '2025-09-30', 5), (1.10, '2025-07-01', '2025-09-30', 6), (0.85, '2025-07-01', '2025-09-30', 7), (1.13, '2025-07-01', '2025-09-30', 8),
(0.87, '2025-10-01', '2025-11-15', 5), (0.86, '2025-10-01', '2025-11-15', 6), (0.88, '2025-10-01', '2025-11-15', 7), (1.04, '2025-10-01', '2025-11-15', 8),
(1.0, '2025-11-16', '2025-11-28', 5), (1.0, '2025-11-16', '2025-11-28', 6), (0.92, '2025-11-16', '2025-11-28', 7), (1.0, '2025-11-16', '2025-11-28', 8),
(1.13, '2025-11-29', '2025-12-31', 5), (1.19, '2025-11-29', '2025-12-31', 6), (0.85, '2025-11-29', '2025-12-31', 7), (1.21, '2025-11-29', '2025-12-31', 8);

-- Insertar algunas habitaciones de ejemplo
INSERT INTO habitaciones (numero, id_tipo_habitacion) VALUES
-- Sunsol Punta Blanca
('101', 1), ('102', 1), ('201', 2), ('202', 2), ('301', 3), ('302', 3), ('401', 4), ('402', 4),
-- Sunsol Ecoland
('101', 5), ('102', 5), ('201', 6), ('202', 6), ('301', 7), ('302', 7), ('401', 8), ('402', 8),
-- Hesperia
('101', 9), ('102', 9), ('201', 10), ('202', 10), ('301', 11), ('302', 11), ('401', 12), ('402', 12),
-- Agua Dorada
('101', 13), ('102', 13), ('201', 14), ('202', 14), ('301', 15), ('302', 15), ('401', 16), ('402', 16);

-- Insertar algunos turistas de ejemplo
INSERT INTO turistas (id_turista, nombre, apellido, telefono, correo, ubicacion) VALUES
('V 31.348.551', 'Miguel', 'Arismendi', '+584141234567', 'moguel@email.com', 'San Juan'),
('V 32.274.853', 'Sebastian', 'Martinez', '+584148765432', 'teamoChacin@email.com', 'Valencia'),
('V 31.648.782', 'Angel', 'Marin', '+584149876543', 'amarin@gmail.com', 'Unimar - Bienestar Estudiantil'),
('V 31.111.111', 'Luis', 'Chacin', '+584143214565', 'luis.platuo@email.com', 'Mi corazon');